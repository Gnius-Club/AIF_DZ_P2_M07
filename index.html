<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>El EscuadrÃ³n Antiâ€‘Zombis Digitales</title>
<style>
  :root{
    --bg:#0b1020;         /* fondo alto contraste */
    --panel:#ffffff;       /* cartas claras */
    --ink:#0a0a0a;         /* texto */
    --accent:#00e0ff;      /* acento HUD */
    --warn:#ffc400;        /* amarillo */
    --danger:#ff4d4d;      /* rojo */
    --ok:#22c55e;          /* verde */
    --gray:#9aa0a6;        /* gris UI */
    --size:clamp(16px, 2.2vh + 1.2vw, 22px); /* tamaÃ±o base responsive */
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:var(--bg);color:var(--panel);
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    font-size:var(--size); line-height:1.35; overflow:hidden;
  }
  h1,h2,h3{margin:0 0 .5rem 0}
  button, .btn{font-size:1.1em; padding:.8rem 1.2rem; border-radius:14px; border:3px solid var(--panel); background:var(--accent); color:#001018; font-weight:800; cursor:pointer}
  button:disabled{opacity:.6; cursor:not-allowed}
  #app{height:100%; display:grid; grid-template-rows:auto 1fr auto}
  header{display:flex; align-items:center; justify-content:space-between; gap:1rem; padding:.6rem .9rem; background:#060913; border-bottom:3px solid #1c2339}
  header .title{display:flex; align-items:center; gap:.6rem; font-weight:900; letter-spacing:.3px}
  header .title .badge{background:var(--accent); color:#001018; padding:.1rem .5rem; border-radius:999px; border:2px solid var(--panel); font-size:.8em}
  header .controls{display:flex; gap:.5rem; flex-wrap:wrap}
  .screen{display:none; height:calc(100vh - 64px); padding:1rem;}
  .screen.active{display:block}
  .scroller{height:100%; overflow:auto}
  .card{background:var(--panel); color:var(--ink); border:4px solid #0f172a; border-radius:18px; padding:1rem}

  /* BRIEFING */
  #briefing .grid{display:grid; grid-template-columns:1fr; gap:1rem;}
  @media(min-width:880px){#briefing .grid{grid-template-columns:1.2fr .8fr}}
  .tutorial-steps li{margin:.4rem 0}
  .example-avatar{display:flex; align-items:center; gap:1rem}
  .example-avatar .avatar{transform:scale(1.2)}

  /* CLUB (partida) */
  #club .hud{display:grid; grid-template-columns:repeat(3,1fr) auto; gap:.6rem; align-items:center; margin-bottom:.7rem}
  .hud .pill{background:#0f172a; border:3px solid #26314e; padding:.4rem .6rem; border-radius:999px; display:flex; align-items:center; gap:.5rem; font-weight:800}
  .hud .pill .n{font-size:1.1em; color:var(--accent)}
  .hud .voice-toggle{justify-self:end}

  .layout{display:grid; grid-template-rows:auto 1fr auto; gap:.7rem; height:calc(100% - 10px)}
  .friends{display:grid; gap:.7rem; grid-template-columns:repeat(3,1fr)}
  @media(max-width:880px){.friends{grid-template-columns:1fr;}}

  .friend{position:relative; padding: .6rem; border-radius:16px; background:#0f172a; border:3px solid #3b486b; outline: none}
  .friend:focus{box-shadow: 0 0 0 4px #3ddcff}
  .friend .name{font-weight:900; letter-spacing:.2px; margin-bottom:.4rem}
  .friend .wrap{display:grid; grid-template-columns:100px 1fr; gap:.6rem; align-items:center}
  @media(max-width:520px){.friend .wrap{grid-template-columns:80px 1fr}}

  /* Avatar minimalista accesible (DOM/CSS) */
  .avatar{width:90px; height:90px; border-radius:16px; background:linear-gradient(180deg,#ffdcb4,#ffb38a); border:4px solid #1f2937; position:relative; overflow:hidden; transition:filter .2s, transform .2s}
  .avatar .eyes{position:absolute; left:50%; top:40%; translate:-50% -50%; display:flex; gap:16px}
  .eye{width:14px; height:14px; background:#111; border-radius:50%; box-shadow:0 0 0 3px #fff inset}
  .eye.red{box-shadow:0 0 0 3px #ff7272 inset}
  .mouth{position:absolute; left:50%; top:64%; translate:-50% -50%; width:36px; height:14px; border-bottom:6px solid #111; border-radius:0 0 40px 40px}
  .avatar .blush{position:absolute; width:16px; height:8px; background:#ff8da1; border-radius:999px; opacity:.7}
  .blush.l{left:16px; top:58px}
  .blush.r{right:16px; top:58px}
  .avatar.tired .mouth{width:26px; height:18px; border-bottom-width:0; border-top:6px solid #111; border-radius:40px 40px 0 0}
  .avatar.hunched{transform:rotate(6deg) translateY(2px)}
  .avatar.zombie{filter:grayscale(1) brightness(.8)}

  /* Estado encima */
  .status{position:absolute; right:6px; top:6px; display:flex; gap:4px}
  .status .sym{font-size:1.2em; background:#0009; border:2px solid #fff; padding:.1rem .25rem; border-radius:10px}
  .sym.hidden{display:none}

  /* Medidor */
  .meter{height:20px; border-radius:10px; background:#1e293b; border:2px solid #0ea5e9; overflow:hidden; position:relative}
  .meter .bar{height:100%; width:0%; background:linear-gradient(90deg, var(--ok), var(--warn), var(--danger)); transition:width .2s}
  .meter .label{position:absolute; inset:0; display:flex; align-items:center; justify-content:center; font-weight:800; color:#001018; text-shadow:0 1px 1px #fff}

  /* Mochila */
  .backpack{display:grid; grid-template-columns:repeat(5,1fr); gap:.6rem}
  @media(max-width:720px){.backpack{grid-template-columns:repeat(3,1fr)}}
  .antidote{position:relative; background:var(--panel); color:var(--ink); border:4px solid #0f172a; border-radius:18px; padding:.5rem; text-align:center; font-weight:900; user-select:none}
  .antidote .big{font-size:1.8em; display:block}
  .antidote .label{display:block; font-size:.9em}
  .antidote:focus{outline:4px solid var(--accent)}
  .antidote.locked{filter:grayscale(1); opacity:.6}
  .antidote.selected{box-shadow:0 0 0 4px var(--accent) inset}

  /* Mensajes y drag */
  #messages{min-height:2.2rem; padding:.4rem .6rem; background:#0f172a; border:2px dashed #26314e; border-radius:12px}
  #dragGhost{position:fixed; pointer-events:none; z-index:9999; transform:translate(-50%,-50%); display:none}
  #dragGhost .antidote{min-width:96px}

  /* FIN y REPORTE */
  .center{height:100%; display:grid; place-items:center}
  .stack{display:grid; gap:.8rem}
  .report-grid{display:grid; gap:.6rem}
  .report-grid .row{display:flex; justify-content:space-between; background:#0f172a; border:2px solid #26314e; border-radius:12px; padding:.5rem .7rem}

  /* Accesible helpers */
  [hidden]{display:none !important}

  /* Animaciones sutiles */
  @keyframes glow{0%{box-shadow:0 0 0 0 rgba(0,224,255,.6)} 100%{box-shadow:0 0 0 16px rgba(0,224,255,0)}}
  .glow{animation:glow 1s ease-out}
</style>
</head>
<body>
<div id="app">
  <header>
    <div class="title"><span class="badge">CiudadanÃ­a Digital</span> <span>El EscuadrÃ³n Antiâ€‘Zombis Digitales</span></div>
    <div class="controls">
      <button id="btnHelp" class="btn" aria-haspopup="dialog" title="Ayuda rÃ¡pida">â“ Ayuda</button>
      <button id="btnMute" class="btn" title="Silenciar sonidos">ğŸ”Š Sonidos</button>
    </div>
  </header>

  <!-- BRIEFING (tutorial) -->
  <section id="briefing" class="screen active">
    <div class="scroller">
      <div class="grid">
        <div class="card">
          <h1>Briefing: Â¡CapitÃ¡n/a, tu misiÃ³n!</h1>
          <p>Eres la/el lÃ­der del <strong>EscuadrÃ³n Antiâ€‘Zombis</strong>. Vigila a 3 amigos en el <em>Club de Juegos</em> y evita que entren al <strong>Modo Zombi Digital</strong>.</p>
          <div class="example-avatar">
            <div class="avatar" aria-hidden="true">
              <div class="eyes"><div class="eye"></div><div class="eye"></div></div>
              <div class="mouth"></div>
              <div class="blush l"></div><div class="blush r"></div>
            </div>
            <ul class="tutorial-steps">
              <li>Umbrales de sÃ­ntomas: <strong>ğŸ‘€ Ojos rojos</strong> â‰¥ 33%, <strong>ğŸ§â€â™€ï¸ Espalda encorvada</strong> â‰¥ 66%.</li>
              <li>Si sube mucho rato: <strong>ğŸ¥± Cansancio</strong> y lentitud.</li>
              <li>Arrastra antÃ­dotos grandes desde la <strong>Mochila</strong> hacia un amigo.</li>
              <li><strong>Momentos inapropiados</strong>: comer y dormir. A mitad del dÃ­a llega la <strong>ğŸ Hora de Merienda</strong>. Â¡Pantallas fuera!</li>
              <li>Si alguien llega a 100%: <strong>ğŸ§Ÿ Zombi Digital</strong>. Aplica <em>tres</em> antÃ­dotos correctos seguidos para salvarlo.</li>
            </ul>
          </div>
          <div class="card" style="margin-top:.6rem">
            <h3>AntÃ­dotos (Mochila)</h3>
            <ul>
              <li>ğŸ’§ <strong>Agua</strong> â†’ ojos rojos. Reduce âˆ’25 y pausa visual 3 s.</li>
              <li>ğŸ§˜ <strong>Estiramiento de Gato</strong> â†’ postura encorvada. Reduce âˆ’30.</li>
              <li>ğŸ¤¸ <strong>Cuerda de Saltar</strong> â†’ cansancio/energÃ­a. Reduce âˆ’35 y da impulso 5 s.</li>
              <li>âš½ <strong>Pelota</strong> â†’ sedentarismo (&gt;15 s sin moverse). Reduce âˆ’20.</li>
              <li>ğŸ <strong>Mesa de Merienda</strong> (evento) â†’ durante merienda reorienta: estabiliza 10 s.</li>
            </ul>
          </div>
          <div style="margin-top:.8rem; display:flex; gap:.6rem; flex-wrap:wrap">
            <button id="btnStart" class="btn">ğŸš€ Â¡Empezar misiÃ³n!</button>
            <button id="btnVoice" class="btn" aria-pressed="false">ğŸ—£ï¸ Voz: OFF</button>
          </div>
        </div>
        <div class="card">
          <h2>Controles</h2>
          <ul>
            <li><strong>Arrastrar</strong> antÃ­doto â†’ soltar sobre un amigo.</li>
            <li><strong>Teclado</strong> (opcional): 1â€‘5 antÃ­doto, â† â†’ amigo, Enter aplicar, R reintentar.</li>
            <li><strong>Accesibilidad</strong>: mensajes con voz opcional y Ã¡rea de dropeo grande.</li>
          </ul>
          <h2 style="margin-top:1rem">Objetivo</h2>
          <p>MantÃ©n a todos con energÃ­a y color durante <strong>90 s</strong>. Â¡Si los 3 son zombis a la vez, perdemos!</p>
        </div>
      </div>
    </div>
  </section>

  <!-- CLUB (partida) -->
  <section id="club" class="screen" aria-live="polite">
    <div class="layout">
      <div class="hud">
        <div class="pill" id="hudTimer" aria-label="Tiempo restante"><span>ğŸ•’ DÃ­a:</span> <span class="n" id="time">90</span>s</div>
        <div class="pill" id="hudScore" aria-label="PuntuaciÃ³n"><span>â­ Puntos:</span> <span class="n" id="score">0</span></div>
        <div class="pill" id="hudCured" aria-label="Zombis curados"><span>ğŸ§Ÿâ€â™‚ï¸ Curados:</span> <span class="n" id="cured">0</span></div>
        <button id="btnVoice2" class="btn voice-toggle" aria-pressed="false">ğŸ—£ï¸ Voz: OFF</button>
      </div>

      <div class="friends" id="friends"></div>

      <div class="card">
        <h3>Mochila de AntÃ­dotos</h3>
        <div class="backpack" id="backpack" role="group" aria-label="Mochila de antÃ­dotos">
          <div class="antidote" data-type="water" tabindex="0" aria-label="ğŸ’§ Agua: ojos rojos (âˆ’25)"><span class="big">ğŸ’§</span><span class="label">Agua</span></div>
          <div class="antidote" data-type="stretch" tabindex="0" aria-label="ğŸ§˜ Estiramiento: postura (âˆ’30)"><span class="big">ğŸ§˜</span><span class="label">Estirar</span></div>
          <div class="antidote" data-type="rope" tabindex="0" aria-label="ğŸ¤¸ Cuerda: cansancio (âˆ’35)"><span class="big">ğŸ¤¸</span><span class="label">Cuerda</span></div>
          <div class="antidote" data-type="ball" tabindex="0" aria-label="âš½ Pelota: sedentarismo (âˆ’20)"><span class="big">âš½</span><span class="label">Pelota</span></div>
          <div class="antidote locked" data-type="apple" tabindex="0" aria-label="ğŸ Merienda: evento (estabiliza)"><span class="big">ğŸ</span><span class="label">Merienda</span></div>
        </div>
        <div id="messages" role="status" aria-live="polite" aria-atomic="true">Consejo: arrastra un antÃ­doto hasta un amigo.</div>
      </div>
    </div>
    <div id="dragGhost"></div>
  </section>

  <!-- FIN -->
  <section id="fin" class="screen">
    <div class="center">
      <div class="card stack" id="finContent"></div>
    </div>
  </section>

  <!-- REPORTE -->
  <section id="reporte" class="screen">
    <div class="center">
      <div class="card" style="max-width:920px; width:95%">
        <h2>Reporte de la MisiÃ³n</h2>
        <div class="report-grid" id="reportGrid" style="margin:.8rem 0"></div>
        <div class="stack" style="margin-top:.8rem">
          <div class="row" style="justify-content:center; gap:.6rem">
            <button id="btnRetry" class="btn">ğŸ”„ Reintentar</button>
            <button id="btnHome" class="btn">ğŸ  Inicio</button>
          </div>
        </div>
      </div>
    </div>
  </section>
</div>

<script>
// ==========================
//  El EscuadrÃ³n Antiâ€‘Zombis Digitales
//  Juego 1 archivo (DOM + rAF) â€” Sin librerÃ­as externas
// ==========================
(() => {
  "use strict";

  // ------ ConfiguraciÃ³n del juego ------
  const GAME_DURATION = 90;            // segundos
  const BASE_RATE = 0.35;              // % por segundo (aumento base del medidor)
  const SEDENTARY_SECONDS = 15;        // inactividad para sedentarismo
  const MERIENDA_TIME = 45;            // aparece a los 45 s
  const MERIENDA_WINDOW = 6;           // 6 s para corregir
  const MERIENDA_STABILIZE = 10;       // estabiliza 10 s si se corrige
  const MERIENDA_PENALTY = 10;         // penalizaciÃ³n 10 s si se ignora (x2)

  const THRESH_EYES = 33;              // ğŸ‘€ ojos rojos
  const THRESH_POSTURE = 66;           // ğŸ§ espalda encorvada

  const EFFECTS = {
    water:   {delta: -25, pauseVisual: 3},
    stretch: {delta: -30},
    rope:    {delta: -35, boost: 5, movement: true},
    ball:    {delta: -20, resetSedentary: true, movement: true},
    apple:   {stabilize: MERIENDA_STABILIZE}
  };

  const NAMES = ["Nico", "Ana", "Leo"];

  // ------ Estado global ------
  let state = {
    screen: "BRIEFING", // BRIEFING â†’ CLUB â†’ FIN â†’ REPORTE
    time: GAME_DURATION,
    running: false,
    score: 0,
    zombiesCured: 0,
    bestCured: Number(localStorage.getItem("bestZombiesCured")||0),
    allZombiesAtOnce: false,
    merienda: {triggered:false, windowEnd:0, active:false},
    selection: {antidoteIndex:0, friendIndex:0},
    metrics: {
      eyesCured: 0,
      backCured: 0,
      movementAntidotes: 0,
      contextCorrections: 0,
      clubLibre: false
    }
  };

  /** @typedef {{id:number, name:string, meter:number, lastMove:number, lastLower:number, riseSince:number, 
   * eyes:boolean, posture:boolean, tired:boolean, sedentary:boolean,
   * penaltyUntil:number, stabilizeUntil:number, pauseVisualUntil:number,
   * tabletInUse:boolean, zombie:boolean, emergencyProgress:number}} Friend */

  /** @type {Friend[]} */
  let friends = [];

  // Tiempo para rAF
  let lastTs = 0;

  // ------ Utilidades de UI ------
  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

  function showScreen(key){
    state.screen = key;
    $$(".screen").forEach(s=>s.classList.remove("active"));
    if(key==="BRIEFING") $("#briefing").classList.add("active");
    if(key==="CLUB") $("#club").classList.add("active");
    if(key==="FIN") $("#fin").classList.add("active");
    if(key==="REPORTE") $("#reporte").classList.add("active");
  }

  function speak(text){
    if(!voiceEnabled) return;
    try{
      const u = new SpeechSynthesisUtterance(text);
      u.lang = pickSpanishVoiceLang();
      window.speechSynthesis.cancel(); // reemplazar mensaje previo
      window.speechSynthesis.speak(u);
    }catch(e){/* silencioso */}
  }
  function pickSpanishVoiceLang(){
    const list = window.speechSynthesis.getVoices ? window.speechSynthesis.getVoices() : [];
    const pref = list.find(v=>/^es(-|$)/i.test(v.lang));
    return pref?pref.lang:"es-MX";
  }

  // Sonidos simples (WebAudio) sin archivos
  let audioCtx = null;
  function beep({type="sine", freq=600, dur=0.12, vol=0.2}){
    if(muted) return;
    try{
      if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = type; o.frequency.value = freq;
      g.gain.value = vol; o.connect(g); g.connect(audioCtx.destination);
      o.start(); setTimeout(()=>{o.stop();}, dur*1000);
    }catch(e){/* nada */}
  }
  function successSound(){beep({type:"triangle", freq:760, dur:0.15});}
  function errorSound(){beep({type:"sawtooth", freq:200, dur:0.25});}
  function siren(){beep({type:"square", freq:180, dur:0.15}); setTimeout(()=>beep({type:"square", freq:240, dur:0.15}),150)}

  let muted = false;
  let voiceEnabled = false;

  // ------ InicializaciÃ³n ------
  function init(){
    // Botones del header
    $("#btnHelp").addEventListener("click", ()=>alert(
      "Objetivo: mantener a 3 amigos con energÃ­a durante 90 s.\n\n"+
      "Arrastra antÃ­dotos desde la mochila hacia un amigo.\n"+
      "Umbrales: ğŸ‘€ â‰¥33%, ğŸ§ â‰¥66%. Evento ğŸ a los 45 s.\n"+
      "Si alguien llega a 100%, usa 3 antÃ­dotos correctos seguidos para salvarlo."
    ));
    $("#btnMute").addEventListener("click", ()=>{
      muted = !muted; $("#btnMute").textContent = muted?"ğŸ”‡ Silencio":"ğŸ”Š Sonidos";
    });

    // Voz toggle
    const toggleVoice = (btn)=>{
      voiceEnabled = !voiceEnabled;
      btn.setAttribute("aria-pressed", String(voiceEnabled));
      btn.textContent = voiceEnabled?"ğŸ—£ï¸ Voz: ON":"ğŸ—£ï¸ Voz: OFF";
      if(voiceEnabled) speak("Comandante del bienestar lista para ayudar");
    };
    $("#btnVoice").addEventListener("click", ()=>toggleVoice($("#btnVoice")));
    $("#btnVoice2").addEventListener("click", ()=>toggleVoice($("#btnVoice2")));

    // Start
    $("#btnStart").addEventListener("click", ()=>{
      startBriefing();
      startDay();
    });

    // Construir UI de amigos
    const friendsWrap = $("#friends");
    friends = NAMES.map((name, i)=>createFriend(i, name));
    friends.forEach(fr=>friendsWrap.appendChild(renderFriendCard(fr)));

    // Drag & drop tÃ¡ctil / mouse
    setupBackpackDrag();

    // Teclado opcional
    setupKeyboard();

    updateHud();
  }

  // Crear objeto Friend
  function createFriend(id,name){
    return {
      id, name, meter: 5 + Math.random()*6, lastMove: now(), lastLower: now(), riseSince: 0,
      eyes:false, posture:false, tired:false, sedentary:false,
      penaltyUntil:0, stabilizeUntil:0, pauseVisualUntil:0,
      tabletInUse:true, zombie:false, emergencyProgress:0
    };
  }

  function renderFriendCard(fr){
    const el = document.createElement("div");
    el.className = "friend"; el.dataset.id = fr.id; el.tabIndex = 0;
    el.innerHTML = `
      <div class="name">${fr.name}</div>
      <div class="wrap">
        <div class="avatar" id="av-${fr.id}">
          <div class="eyes"><div class="eye l"></div><div class="eye r"></div></div>
          <div class="mouth"></div>
          <div class="blush l"></div><div class="blush r"></div>
        </div>
        <div>
          <div class="meter" aria-label="Medidor de zombificaciÃ³n de ${fr.name}">
            <div class="bar" id="bar-${fr.id}"></div>
            <div class="label" id="lab-${fr.id}">0%</div>
          </div>
          <div class="status">
            <span class="sym eyes hidden" id="sym-eyes-${fr.id}">ğŸ‘€</span>
            <span class="sym posture hidden" id="sym-posture-${fr.id}">ğŸ§</span>
            <span class="sym tired hidden" id="sym-tired-${fr.id}">ğŸ¥±</span>
            <span class="sym sedentary hidden" id="sym-sed-${fr.id}">ğŸª‘</span>
            <span class="sym zombie hidden" id="sym-z-${fr.id}">ğŸ§Ÿ</span>
          </div>
        </div>
      </div>`;
    el.addEventListener("click",()=>selectFriend(fr.id));
    return el;
  }

  function selectFriend(id){
    state.selection.friendIndex = id;
    highlightSelection();
  }

  function highlightSelection(){
    $$(".friend").forEach(el=>el.style.outline = "none");
    const focused = $(`.friend[data-id="${state.selection.friendIndex}"]`);
    if(focused) focused.style.outline = "4px solid #3ddcff";

    $$(".antidote").forEach((el,i)=>{
      if(i===state.selection.antidoteIndex) el.classList.add("selected");
      else el.classList.remove("selected");
    });
  }

  // ------ MÃ¡quina de estados ------
  function startBriefing(){
    showScreen("CLUB"); // pasamos directo al tablero, briefing ya visible arriba
    message("Consejo: usa la mochila para curar sÃ­ntomas. Â¡Buena suerte!");
    speak("Briefing completado. Iniciando misiÃ³n en el Club de Juegos.");
  }

  function startDay(){
    // Reset del estado
    state.time = GAME_DURATION; state.running = true; state.score = 0; state.zombiesCured = 0; state.allZombiesAtOnce=false;
    state.merienda = {triggered:false, windowEnd:0, active:false};
    state.metrics = {eyesCured:0, backCured:0, movementAntidotes:0, contextCorrections:0, clubLibre:false};

    // Reset amigos
    friends.forEach(fr=>{
      Object.assign(fr, createFriend(fr.id, fr.name));
      // leve variaciÃ³n para no ser idÃ©nticos
      fr.meter = 4 + Math.random()*10;
    });

    lastTs = performance.now();
    requestAnimationFrame(loop);
    updateHud();
  }

  function endGame(victory){
    state.running = false;
    state.metrics.clubLibre = victory;
    showScreen("FIN");

    const box = $("#finContent");
    box.innerHTML = "";
    const title = document.createElement("h1");
    title.textContent = victory?"ğŸ† Â¡Victoria! DÃ­a completado":"â›” Â¡Derrota! Todos fueron zombis";
    const p = document.createElement("p");
    p.textContent = victory?"Â¡Gran trabajo, CapitÃ¡n/a! La ciudadanÃ­a digital estÃ¡ a salvo por hoy." : "La Comandante del Bienestar sugiere mÃ¡s descansos y movimiento.";
    const btnReport = document.createElement("button"); btnReport.className = "btn"; btnReport.textContent = "ğŸ“Š Ver Reporte"; btnReport.onclick = ()=>showReport();
    const btnRetry = document.createElement("button"); btnRetry.className = "btn"; btnRetry.textContent = "ğŸ”„ Reintentar"; btnRetry.onclick = ()=>{showScreen("CLUB"); startDay();};

    const row = document.createElement("div"); row.className = "stack"; row.append(title, p, btnReport, btnRetry);
    box.append(row);

    // Guardar ranking
    if(state.zombiesCured > state.bestCured){
      state.bestCured = state.zombiesCured;
      localStorage.setItem("bestZombiesCured", String(state.bestCured));
    }
  }

  function showReport(){
    showScreen("REPORTE");
    const g = $("#reportGrid");
    g.innerHTML = "";
    const items = [
      ["Curaste casos de ojos cansados", state.metrics.eyesCured],
      ["Curaste casos de espalda de zombi", state.metrics.backCured],
      ["Aplicaste antÃ­dotos de movimiento", state.metrics.movementAntidotes],
      ["Corregiste momentos inapropiados", state.metrics.contextCorrections],
      ["Zombis curados", state.zombiesCured],
      ["PuntuaciÃ³n final", state.score],
      ["Club libre de zombis", state.metrics.clubLibre?"SÃ­":"No"],
      ["Mejor marca local â€” Zombis curados", state.bestCured]
    ];
    for(const [label,val] of items){
      const row = document.createElement("div"); row.className = "row";
      const a = document.createElement("div"); a.textContent = label;
      const b = document.createElement("div"); b.innerHTML = `<strong>${val}</strong>`;
      row.append(a,b); g.append(row);
    }
    $("#btnRetry").onclick = ()=>{showScreen("CLUB"); startDay();};
    $("#btnHome").onclick = ()=>{showScreen("BRIEFING")};
  }

  // ------ Bucle del juego ------
  function loop(ts){
    if(!state.running) return;
    const dt = Math.min(0.05, (ts - lastTs)/1000); // tope dt 50 ms para estabilidad
    lastTs = ts;

    update(dt);
    render();

    if(state.running) requestAnimationFrame(loop);
  }

  function update(dt){
    // Tiempo
    state.time = Math.max(0, state.time - dt);

    // Evento de merienda
    const elapsed = GAME_DURATION - state.time;
    if(!state.merienda.triggered && elapsed >= MERIENDA_TIME){
      triggerContextEvent("merienda");
    }
    if(state.merienda.active && now() > state.merienda.windowEnd){
      // Fin de ventana de 6 s â†’ penaliza a quien siguiÃ³ con pantalla
      state.merienda.active = false;
      $(`[data-type="apple"]`).classList.add("locked");
      let penalizados = 0;
      friends.forEach(fr=>{
        if(fr.tabletInUse){
          fr.penaltyUntil = now() + MERIENDA_PENALTY;
          penalizados++;
        }
      });
      if(penalizados>0){
        message(`Merienda ignorada por ${penalizados}. Aumento acelerado 10 s.`, true);
      } else {
        message("Â¡Excelente! Merienda respetada. Estabilidad ganada.");
      }
    }

    // Actualizar amigos
    let zombiesNow = 0;
    friends.forEach(fr=>{
      // Recalcular sÃ­ntomas derivados por umbrales y tendencias
      const wasMeter = fr.meter;

      if(!fr.zombie){
        // Aumentos
        let rate = BASE_RATE;
        // Pausa visual por agua
        if(fr.pauseVisualUntil > now()) rate = 0;
        // Sedentarismo sostenido agrega extra
        fr.sedentary = (now() - fr.lastMove) > SEDENTARY_SECONDS;
        if(fr.sedentary) rate += 0.15;
        // PenalizaciÃ³n por ignorar merienda
        if(fr.penaltyUntil > now()) rate *= 2;
        // Estabilidad por merienda corregida
        if(fr.stabilizeUntil > now()) rate *= .5;

        fr.meter = clamp(fr.meter + rate*dt, 0, 100);

        // Tendencia para "cansancio" si sube 8 s seguidos sin bajar
        if(fr.meter > wasMeter) fr.riseSince += dt; else { fr.riseSince = 0; fr.lastLower = now(); }
        fr.tired = fr.riseSince > 8;

        // Umbrales de ojos y postura
        fr.eyes = fr.meter >= THRESH_EYES;
        fr.posture = fr.meter >= THRESH_POSTURE;

        // Si llega a 100 â†’ Zombi
        if(fr.meter >= 100 && !fr.zombie){
          enterZombie(fr);
        }
      }

      if(fr.zombie) zombiesNow++;
    });

    if(zombiesNow === friends.length){
      state.allZombiesAtOnce = true;
      endGame(false);
      return;
    }

    // Fin del dÃ­a
    if(state.time <= 0){
      endGame(true);
      return;
    }
  }

  function render(){
    // HUD
    updateHud();

    friends.forEach(fr=>{
      const pct = Math.round(fr.meter);
      const bar = $(`#bar-${fr.id}`); const lab = $(`#lab-${fr.id}`); const av = $(`#av-${fr.id}`);
      if(bar) bar.style.width = `${pct}%`;
      if(lab) lab.textContent = `${pct}%`;

      // Colores de barra por estado
      const meterEl = lab.parentElement;
      meterEl.style.borderColor = fr.zombie?"var(--danger)":(pct<33?"var(--ok)":pct<66?"var(--warn)":"var(--danger)");

      // Avatar flags
      av.classList.toggle("zombie", fr.zombie);
      av.classList.toggle("tired", fr.tired);
      av.classList.toggle("hunched", fr.posture && !fr.zombie);
      // Ojos
      av.querySelectorAll('.eye').forEach(e=>e.classList.toggle('red', fr.eyes && !fr.zombie));

      // SÃ­mbolos
      toggleSym(`sym-eyes-${fr.id}`, fr.eyes && !fr.zombie);
      toggleSym(`sym-posture-${fr.id}`, fr.posture && !fr.zombie);
      toggleSym(`sym-tired-${fr.id}`, fr.tired && !fr.zombie);
      toggleSym(`sym-sed-${fr.id}`, fr.sedentary && !fr.zombie);
      toggleSym(`sym-z-${fr.id}`, fr.zombie);

      // Aria label accesible
      const friendCard = $(`.friend[data-id="${fr.id}"]`);
      if(friendCard) friendCard.setAttribute("aria-label", `${fr.name}, medidor ${pct}%`);
    });
  }

  function toggleSym(id, on){
    const el = $(`#${id}`); if(!el) return; el.classList.toggle("hidden", !on);
  }

  function updateHud(){
    $("#time").textContent = Math.ceil(state.time);
    $("#score").textContent = Math.round(state.score);
    $("#cured").textContent = state.zombiesCured;
  }

  function enterZombie(fr){
    fr.zombie = true; fr.meter = 100; fr.emergencyProgress = 0;
    message(`Â¡Oh, no! ${fr.name} entrÃ³ en Modo Zombi.`, true);
    siren(); speak("Oh no. Â¡Un zombi digital!");
    state.score -= 15; // pÃ©rdida de puntos al activarse
  }

  // ------ AntÃ­dotos ------
  function applyAntidote(type, friendId){
    const fr = friends.find(f=>f.id===friendId);
    if(!fr) return;

    // ğŸ solo durante evento
    if(type === 'apple' && !state.merienda.active){
      message("La mesa de merienda solo aparece durante el evento.");
      errorSound(); return;
    }

    if(fr.zombie){
      // En emergencia: cuentan antÃ­dotos correctos (movimiento + agua/estirar) segÃºn sÃ­ntomas visibles
      let correct = false;
      if((type==='rope' || type==='ball')){ correct = true; state.metrics.movementAntidotes++; }
      if((fr.eyes && type==='water') || (fr.posture && type==='stretch')) correct = true;
      if(correct){
        fr.emergencyProgress++;
        fr.meter = clamp(fr.meter + (EFFECTS[type]?.delta||0), 0, 100);
        success();
        message(`Rescate en progreso (${fr.emergencyProgress}/3) a ${fr.name}`);
        if(fr.emergencyProgress>=3){
          fr.zombie = false; fr.meter = 50; fr.pauseVisualUntil = 0; fr.penaltyUntil = 0; fr.stabilizeUntil = 0; fr.riseSince = 0; fr.lastMove = now();
          state.zombiesCured++; state.score += 25;
          message(`Â¡${fr.name} vuelve a la vida!`, false, true);
          speak("Mente en la pantalla, cuerpo en acciÃ³n, esa es la perfecta combinaciÃ³n!");
        }
      }else{
        error("Ese antÃ­doto no ayuda en emergencia.");
      }
      return;
    }

    // Normal
    const eff = EFFECTS[type];
    let ok = false;

    if(type==='water' && fr.eyes){
      ok = true; fr.meter = clamp(fr.meter + eff.delta, 0, 100); fr.pauseVisualUntil = now() + eff.pauseVisual; state.metrics.eyesCured++;
    } else if(type==='stretch' && fr.posture){
      ok = true; fr.meter = clamp(fr.meter + eff.delta, 0, 100); state.metrics.backCured++;
    } else if(type==='rope' && fr.tired){
      ok = true; fr.meter = clamp(fr.meter + eff.delta, 0, 100); fr.stabilizeUntil = now() + eff.boost; state.metrics.movementAntidotes++;
    } else if(type==='ball' && fr.sedentary){
      ok = true; fr.meter = clamp(fr.meter + eff.delta, 0, 100); fr.lastMove = now(); state.metrics.movementAntidotes++;
    } else if(type==='apple' && state.merienda.active && fr.tabletInUse){
      ok = true; fr.tabletInUse = false; fr.stabilizeUntil = now() + eff.stabilize; state.metrics.contextCorrections++; state.score += 5;
    }

    if(ok){
      success();
      $("#messages").classList.add("glow"); setTimeout(()=>$("#messages").classList.remove("glow"), 350);
      const txt = type==='apple'?"Â¡Excelente! Cada cosa a su tiempo." : "Â¡Gran intervenciÃ³n, CapitÃ¡n! EnergÃ­a recargada.";
      message(txt);
      speak(type==='apple'?"Hora de merienda: pantallas fuera": "Gran intervenciÃ³n, CapitÃ¡n");
    } else {
      error("Ese antÃ­doto no corresponde al sÃ­ntoma.");
    }
  }

  function success(){ successSound(); state.score += 10; }
  function error(msg){ errorSound(); state.score -= 5; message(msg, true); }

  function message(text, warn=false, big=false){
    const el = $("#messages");
    el.textContent = text;
    el.style.borderColor = warn?"var(--danger)":"#26314e";
    if(big){ el.style.fontWeight = "900"; setTimeout(()=>el.style.fontWeight="700", 600); }
  }

  function triggerContextEvent(name){
    if(name!=="merienda") return;
    state.merienda = {triggered:true, windowEnd: now()+MERIENDA_WINDOW, active:true};
    message("ğŸ Hora de merienda: Â¡pantallas fuera! Usa la mesa si alguien sigue con la tablet.");
    speak("Hora de merienda: pantallas fuera");
    const apple = $(`[data-type="apple"]`);
    apple.classList.remove("locked");
    apple.classList.add("glow"); setTimeout(()=>apple.classList.remove("glow"), 1200);
    // Marcar a todos temporalmente como usando tablet (ya lo estÃ¡n), si se corrige, se estabiliza
    friends.forEach(fr=>{ fr.tabletInUse = true; });
  }

  // ------ Drag & Drop tÃ¡ctil/mouse ------
  function setupBackpackDrag(){
    const backpack = $("#backpack");
    const ghost = $("#dragGhost");
    let dragging = null;

    const startDrag = (target, x, y)=>{
      if(target.classList.contains('locked')) return; // bloqueado (ğŸ fuera de evento)
      dragging = {type: target.dataset.type, el: target};
      ghost.innerHTML = ""; const g = target.cloneNode(true); g.style.transform = "scale(1.1)"; ghost.appendChild(g);
      ghost.style.display = "block"; moveGhost(x,y);
      document.addEventListener("pointermove", onMove);
      document.addEventListener("pointerup", onUp, {once:true});
    };

    const onMove = (e)=>{ moveGhost(e.clientX, e.clientY); };
    const moveGhost = (x,y)=>{ ghost.style.left = x+"px"; ghost.style.top = y+"px"; };

    const onUp = (e)=>{
      ghost.style.display = "none"; ghost.innerHTML = ""; dragging && applyDrop(e.clientX, e.clientY, dragging.type);
      dragging = null; document.removeEventListener("pointermove", onMove);
    };

    function applyDrop(x,y,type){
      const el = document.elementFromPoint(x,y);
      const friendEl = el?.closest?.('.friend');
      if(friendEl){
        const id = Number(friendEl.dataset.id);
        applyAntidote(type, id);
      } else {
        message("Suelta el antÃ­doto sobre un amigo.");
        errorSound();
      }
    }

    backpack.addEventListener("pointerdown", (e)=>{
      const t = e.target.closest('.antidote'); if(!t) return; e.preventDefault();
      startDrag(t, e.clientX, e.clientY);
    });

    // Accesibilidad con Enter/Espacio en la mochila: seleccionar antÃ­doto
    $$(".antidote").forEach((btn, idx)=>{
      btn.addEventListener("keydown", (e)=>{
        if(e.key==="Enter" || e.key===" "){ e.preventDefault(); state.selection.antidoteIndex = idx; highlightSelection(); message("AntÃ­doto seleccionado. Usa Enter para aplicar."); }
      });
    });
  }

  // ------ Teclado opcional ------
  function setupKeyboard(){
    window.addEventListener('keydown', (e)=>{
      if(state.screen!=="CLUB") return;
      const maxAnt = 5;
      if(e.key>='1' && e.key<='5'){
        const idx = Number(e.key)-1; state.selection.antidoteIndex = idx; highlightSelection(); successSound(); return;
      }
      if(e.key==='ArrowLeft') { state.selection.friendIndex = (state.selection.friendIndex+2)%3; highlightSelection(); return; }
      if(e.key==='ArrowRight'){ state.selection.friendIndex = (state.selection.friendIndex+1)%3; highlightSelection(); return; }
      if(e.key==='Enter'){
        const type = ["water","stretch","rope","ball","apple"][state.selection.antidoteIndex]||"water";
        applyAntidote(type, state.selection.friendIndex);
        return;
      }
      if(e.key==='r' || e.key==='R'){ showScreen("CLUB"); startDay(); return; }
    });
  }

  // ------ Helpers ------
  const now = ()=>performance.now()/1000;
  const clamp = (v,min,max)=>v<min?min:v>max?max:v;

  // Inicio
  window.addEventListener('load', init, {once:true});
})();
</script>
</body>
</html>
