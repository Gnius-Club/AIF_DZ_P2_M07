<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>El Escuadr√≥n Anti-Zombis (Final)</title>
<style>
  :root{
    --bg:#0b1020;
    --panel:#ffffff;
    --ink:#0a0a0a;
    --accent:#00e0ff;
    --warn:#ffc400;
    --danger:#ff4d4d;
    --ok:#22c55e;
    --size:clamp(16px, 2.5vh + 1vw, 24px);
  }
  *{box-sizing:border-box; user-select:none; -webkit-user-select:none; touch-action:none;}
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--panel);
    font-family: "Comic Sans MS", "Chalkboard SE", system-ui, sans-serif;
    font-size:var(--size); line-height:1.4; overflow:hidden;
  }
  
  /* UI GENERAL */
  button, .btn{
    font-family:inherit; font-size:1em; padding:.8rem 1.5rem; border-radius:20px; 
    border:4px solid #fff; background:var(--accent); color:#001018; 
    font-weight:900; cursor:pointer; box-shadow:0 4px 0 rgba(0,0,0,0.3);
    transition:transform .1s;
  }
  button:active{transform:translateY(4px); box-shadow:none;}
  button.secondary{background:#3b82f6; color:white;}
  
  #app{height:100%; display:grid; grid-template-rows:auto 1fr auto}
  
  header{
    background:#1e293b; padding:.5rem 1rem; border-bottom:4px solid #0f172a;
    display:flex; align-items:center; justify-content:space-between; gap:1rem;
  }
  header h1{font-size:1.1em; margin:0; color:var(--accent); text-shadow:1px 1px 0 #000;}
  
  .screen{display:none; height:calc(100vh - 70px); padding:1rem; animation:fadeIn .5s;}
  .screen.active{display:block;}
  .scroller{height:100%; overflow-y:auto; padding-bottom:2rem;}
  
  /* TARJETAS */
  .card{
    background:var(--panel); color:var(--ink); border:5px solid #0f172a; 
    border-radius:25px; padding:1.5rem; margin-bottom:1rem;
    box-shadow: 6px 6px 0 rgba(0,0,0,0.4);
  }
  
  /* JUEGO - Layout */
  .layout{display:grid; grid-template-rows:auto 1fr auto; gap:.5rem; height:100%;}
  
  /* HUD */
  .hud{display:flex; justify-content:space-around; background:#1e293b; padding:.5rem; border-radius:15px; border:3px solid #334155;}
  .hud-item{text-align:center;}
  .hud-label{font-size:0.7em; text-transform:uppercase; color:#94a3b8; display:block;}
  .hud-val{font-size:1.3em; font-weight:900; color:var(--accent);}

  /* AMIGOS */
  .friends-grid{
    display:grid; grid-template-columns:repeat(3, 1fr); gap:.8rem; height:100%;
    align-content:center;
  }
  @media(max-width:700px){ .friends-grid{grid-template-columns:1fr;} }

  .friend{
    position:relative; background:#1e293b; border:4px solid #334155; 
    border-radius:20px; padding:1rem; text-align:center;
    transition: transform .2s, border-color .2s;
  }
  .friend.critical{border-color:var(--danger); animation:shake .5s infinite;}

  /* AVATAR */
  .avatar-container{position:relative; display:inline-block; margin-bottom:.5rem;}
  .avatar{
    width:100px; height:100px; background:#ffdcb4; border-radius:50%; 
    border:4px solid #fff; position:relative; overflow:hidden;
    transition: filter .3s, background .3s;
  }
  .avatar.zombie-skin{background:#799f7d; filter:grayscale(0.4) contrast(1.2);}
  
  .face-parts{position:absolute; inset:0; transition:transform .3s;}
  .eyes{position:absolute; top:35%; left:50%; transform:translate(-50%,-50%); display:flex; gap:14px;}
  .eye{width:16px; height:16px; background:#000; border-radius:50%; position:relative;}
  .avatar.eyes-red .eye{background:#ff0000; box-shadow:0 0 6px red;}

  .mouth{position:absolute; top:70%; left:50%; transform:translate(-50%,-50%); width:30px; height:10px; background:#000; border-radius:0 0 20px 20px;}
  .avatar.tired .mouth{height:16px; border-radius:50%; width:16px;}

  /* BURBUJAS DE S√çNTOMAS */
  .symptom-bubble{
    position:absolute; top:-20px; right:-20px; background:#fff; border:3px solid var(--danger);
    color:var(--ink); width:50px; height:50px; border-radius:50%;
    display:flex; align-items:center; justify-content:center; font-size:1.8em;
    box-shadow:2px 2px 5px rgba(0,0,0,0.3); z-index:10;
    animation: popIn .3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  }
  .symptom-bubble.hidden{display:none;}
  .symptom-bubble.pulse{animation:pulse 0.8s infinite;}

  /* BARRA DE ENERG√çA */
  .meter-box{background:#000; height:24px; border-radius:12px; border:2px solid #555; position:relative; overflow:hidden; margin-top:5px;}
  .meter-bar{height:100%; width:0%; background:linear-gradient(90deg, #22c55e, #eab308, #ef4444); transition:width .1s linear;}

  /* MOCHILA / CONTROLES */
  .backpack-area{background:#1e293b; padding:.5rem; border-radius:20px; border:4px solid #334155;}
  .backpack-title{text-align:center; font-size:.9em; color:#94a3b8; margin-bottom:.5rem;}
  .tools-grid{display:grid; grid-template-columns:repeat(5, 1fr); gap:.5rem;}
  
  .tool{
    background:#fff; border:3px solid #ccc; border-radius:15px; padding:.4rem; 
    text-align:center; cursor:pointer; position:relative;
    transition: transform .1s;
  }
  .tool:active{transform:scale(0.95);}
  .tool img, .tool .emoji{font-size:2em; display:block; margin:0 auto;}
  .tool span{font-size:0.7em; font-weight:bold; display:block; color:#333; line-height:1.1;}
  .tool.locked{filter:grayscale(1); opacity:0.5; pointer-events:none;}
  .tool.suggested{animation:bounce 1s infinite; border-color:var(--accent); box-shadow:0 0 10px var(--accent);}

  /* REPORTE COLORIDO */
  .report-screen{display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%;}
  .report-card{
    background:#fff; border-radius:30px; border:6px solid #3b82f6; width:95%; max-width:500px;
    padding:2rem; text-align:center; color:#333; position:relative;
    box-shadow:0 20px 50px rgba(0,0,0,0.5);
    animation:slideUp .5s;
  }
  .report-card.win{border-color:var(--ok);}
  .report-card.lose{border-color:var(--danger);}

  /* Feedback Flotante */
  .floater{
    position:absolute; font-weight:900; font-size:1.5em; pointer-events:none; z-index:99;
    text-shadow:2px 2px 0 #000; animation:floatUp 1s forwards;
  }
  .big-alert{
    position:absolute; top:30%; left:50%; transform:translate(-50%,-50%);
    background:#ffc400; color:#000; font-size:1.5em; font-weight:900; padding:1rem;
    border-radius:20px; border:5px solid #fff; z-index:100; animation:popIn .5s;
    pointer-events:none; text-align:center; box-shadow:0 10px 20px rgba(0,0,0,0.5);
  }

  /* Animaciones */
  @keyframes fadeIn{from{opacity:0}to{opacity:1}}
  @keyframes popIn{from{transform:scale(0)}to{transform:scale(1)}}
  @keyframes floatUp{0%{transform:translateY(0); opacity:1} 100%{transform:translateY(-50px); opacity:0}}
  @keyframes pulse{0%{transform:scale(1);} 50%{transform:scale(1.15);} 100%{transform:scale(1);}}
  @keyframes shake{0%{transform:translateX(0)} 25%{transform:translateX(-5px)} 75%{transform:translateX(5px)} 100%{transform:translateX(0)}}
  @keyframes bounce{0%, 100%{transform:translateY(0)} 50%{transform:translateY(-10px)}}
  @keyframes slideUp{from{transform:translateY(50px); opacity:0} to{transform:translateY(0); opacity:1}}

  /* Drag Ghost */
  #dragGhost{position:fixed; pointer-events:none; z-index:1000; transform:translate(-50%,-50%); display:none; font-size:3em;}
</style>
</head>
<body>

<div id="app">
  <!-- HEADER -->
  <header>
    <h1>üõ°Ô∏è Escuadr√≥n Anti-Zombis</h1>
    <button id="btnMute" style="padding:.4rem .8rem; font-size:.8em;">üîä</button>
  </header>

  <!-- PANTALLA 1: BRIEFING -->
  <section id="briefing" class="screen active">
    <div class="scroller">
      <div class="card">
        <h2 style="text-align:center; font-size:1.5em;">¬°Misi√≥n Importante! ‚ö°</h2>
        <p>Los s√≠ntomas aparecer√°n <strong>de repente y al azar</strong>. ¬°Tienes que ser muy r√°pido!</p>
        
        <p><strong>Si ves el √≠cono, arrastra la cura antes de que sea tarde:</strong></p>

        <div style="display:flex; justify-content:space-around; margin:1rem 0; flex-wrap:wrap; gap:10px;">
          <div style="text-align:center">üëÄ<br>Agua</div>
          <div style="text-align:center">ü¶ê<br>Estirar</div>
          <div style="text-align:center">üï∏Ô∏è<br>Pelota</div>
          <div style="text-align:center">‚ö°<br>Saltar</div>
        </div>

        <button id="btnStart" class="btn" style="width:100%; font-size:1.2em;">üöÄ ¬°Entendido, vamos!</button>
      </div>
    </div>
  </section>

  <!-- PANTALLA 2: JUEGO -->
  <section id="club" class="screen">
    <div class="layout">
      <!-- HUD -->
      <div class="hud">
        <div class="hud-item">
          <span class="hud-label">Tiempo</span>
          <span class="hud-val" id="timer">90</span>
        </div>
        <div class="hud-item">
          <span class="hud-label">Salvados</span>
          <span class="hud-val" id="score">0</span>
        </div>
      </div>

      <!-- ZONA DE AMIGOS -->
      <div class="friends-grid" id="friends-container"></div>

      <!-- MOCHILA -->
      <div class="backpack-area">
        <div class="backpack-title">üéí MOCHILA (¬°Arrastra r√°pido!)</div>
        <div class="tools-grid" id="backpack">
          <div class="tool" data-type="water">
            <div class="emoji">üíß</div><span>Agua</span>
          </div>
          <div class="tool" data-type="stretch">
            <div class="emoji">üßò</div><span>Estirar</span>
          </div>
          <div class="tool" data-type="ball">
            <div class="emoji">‚öΩ</div><span>Pelota</span>
          </div>
          <div class="tool" data-type="rope">
            <div class="emoji">ü§∏</div><span>Saltar</span>
          </div>
          <div class="tool locked" id="tool-apple" data-type="apple">
            <div class="emoji">üçé</div><span>Merienda</span>
          </div>
        </div>
      </div>
    </div>
    <div id="dragGhost"></div>
  </section>

  <!-- PANTALLA 3: REPORTE -->
  <section id="reporte" class="screen">
    <div class="report-screen">
      <div class="report-card" id="reportCard">
        <div id="reportIcon" style="font-size:4em; margin-bottom:-10px;">üèÜ</div>
        <h1 id="reportTitle" style="margin:0; font-size:1.8em;">¬°Fin del Juego!</h1>
        <p id="reportMsg" style="color:#666; margin-bottom:1.5rem;"></p>
        
        <div style="background:#f8fafc; padding:1rem; border-radius:15px; margin-bottom:1.5rem;">
          <div style="display:flex; justify-content:space-between; margin-bottom:.5rem;">
            <span>üßü Zombis:</span> <strong id="statZombies">0</strong>
          </div>
          <div style="display:flex; justify-content:space-between;">
            <span>üè• Puntos:</span> <strong id="statScore">0</strong>
          </div>
        </div>

        <button id="btnRetry" class="btn secondary">üîÑ Jugar Otra Vez</button>
      </div>
    </div>
  </section>
</div>

<script>
const GAME_CONFIG = {
  duration: 90,
  baseFillRate: 1.5,     // Llenado natural lento
  dangerFillRate: 15,    // Si hay s√≠ntoma, sube 15% por segundo (aprox 6 segundos para morir)
  meriendaTime: 45,      // Segundos restantes cuando ocurre
  meriendaDuration: 10,  // Duraci√≥n del evento merienda
  rngIntervalMin: 2,     // M√≠nimo segundos para nuevo s√≠ntoma
  rngIntervalMax: 4      // M√°ximo segundos para nuevo s√≠ntoma
};

const TOOLS = {
  water:   { effect: -40, sound: 'glup' },
  stretch: { effect: -40, sound: 'stretch' },
  ball:    { effect: -40, sound: 'boing', moves: true },
  rope:    { effect: -50, sound: 'jump', moves: true },
  apple:   { effect: -30, sound: 'bite' }
};

let state = {
  playing: false,
  time: 0,
  score: 0,
  zombiesCount: 0,
  meriendaActive: false,
  meriendaGracePeriod: false, // Breve pausa al inicio de merienda
  nextSymptomTimer: 2, 
  friends: []
};

let loopId = null;
let lastTime = 0;
let audioCtx = null;
let muted = false;

// --- INICIO ---
window.addEventListener('load', () => {
  document.getElementById('btnStart').onclick = startGame;
  document.getElementById('btnRetry').onclick = () => showScreen('briefing');
  document.getElementById('btnMute').onclick = toggleMute;
  setupDragAndDrop();
});

function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

function startGame() {
  state = {
    playing: true,
    time: GAME_CONFIG.duration,
    score: 0,
    zombiesCount: 0,
    meriendaActive: false,
    meriendaGracePeriod: false,
    nextSymptomTimer: 2,
    friends: ['Leo', 'Ana', 'Dani'].map((n, i) => ({
      id: i, name: n, meter: 5, isZombie: false,
      activeSymptom: null, // 'eyes', 'posture', 'sedentary', 'tired', 'hungry'
      frozen: false
    }))
  };

  renderFriends();
  
  // Reset Merienda UI
  const appleBtn = document.getElementById('tool-apple');
  appleBtn.classList.add('locked');
  appleBtn.classList.remove('suggested');

  showScreen('club');
  playSound('start');
  
  lastTime = performance.now();
  loopId = requestAnimationFrame(gameLoop);
}

// --- LOGICA ---
function gameLoop(timestamp) {
  if (!state.playing) return;
  const dt = (timestamp - lastTime) / 1000;
  lastTime = timestamp;

  if(dt > 1) { loopId = requestAnimationFrame(gameLoop); return; }

  updateLogic(dt);
  updateVisuals();

  if (state.playing) loopId = requestAnimationFrame(gameLoop);
}

function updateLogic(dt) {
  state.time -= dt;

  // 1. Fin por tiempo
  if (state.time <= 0) { endGame(true); return; }

  // 2. Merienda (Evento fijo)
  const elapsed = GAME_CONFIG.duration - state.time;
  if (!state.meriendaActive && elapsed > GAME_CONFIG.meriendaTime && elapsed < GAME_CONFIG.meriendaTime + 1) {
    triggerMerienda();
  }
  if (state.meriendaActive && elapsed > GAME_CONFIG.meriendaTime + GAME_CONFIG.meriendaDuration) {
    endMerienda();
  }

  // 3. GENERADOR DE S√çNTOMAS ALEATORIOS (RNG)
  // Solo genera nuevos problemas si NO estamos en merienda
  if (!state.meriendaActive) {
    state.nextSymptomTimer -= dt;
    if (state.nextSymptomTimer <= 0) {
      assignRandomSymptom();
      state.nextSymptomTimer = Math.random() * (GAME_CONFIG.rngIntervalMax - GAME_CONFIG.rngIntervalMin) + GAME_CONFIG.rngIntervalMin;
    }
  }

  // 4. Actualizar Amigos
  let allZombies = true;
  state.friends.forEach(f => {
    if (f.frozen) return; // Si se cur√≥, pausa breve
    
    if (!f.isZombie) {
      allZombies = false;
      
      let currentRate = GAME_CONFIG.baseFillRate;
      
      // L√ìGICA DE VELOCIDAD DE DA√ëO
      if (state.meriendaActive) {
        if(state.meriendaGracePeriod) {
          currentRate = 0; // Pausa 1.5s al aparecer el letrero
        } else if (f.activeSymptom === 'hungry') {
          // Velocidad IGUAL a otros s√≠ntomas, no m√°s r√°pido
          currentRate = GAME_CONFIG.dangerFillRate; 
        } else {
          // Si ya comi√≥ (no tiene s√≠ntoma hungry), sube lento
          currentRate = GAME_CONFIG.baseFillRate;
        }
      } 
      else if (f.activeSymptom) {
        // S√≠ntoma normal (ojos, espalda, rayo, etc)
        currentRate = GAME_CONFIG.dangerFillRate;
      }

      f.meter += currentRate * dt;

      // Convertir a Zombi
      if (f.meter >= 100) {
        f.meter = 100;
        f.isZombie = true;
        f.activeSymptom = null;
        playSound('zombie');
        showFloatText(f.id, "¬°OH NO!", "red");
        state.zombiesCount++;
      }
    }
  });

  if (allZombies) endGame(false);
}

function assignRandomSymptom() {
  const candidates = state.friends.filter(f => !f.isZombie && !f.activeSymptom);
  if (candidates.length === 0) return;

  const friend = candidates[Math.floor(Math.random() * candidates.length)];
  // AHORA INCLUYE 'tired' (Saltar)
  const symptoms = ['eyes', 'posture', 'sedentary', 'tired'];
  const symptom = symptoms[Math.floor(Math.random() * symptoms.length)];

  friend.activeSymptom = symptom;
  playSound('alert');
}

// --- VISUALES ---
function renderFriends() {
  const container = document.getElementById('friends-container');
  container.innerHTML = '';
  state.friends.forEach(f => {
    const div = document.createElement('div');
    div.className = 'friend';
    div.id = `friend-${f.id}`;
    div.innerHTML = `
      <div class="symptom-bubble hidden" id="sym-${f.id}"></div>
      <div class="avatar-container">
        <div class="avatar" id="av-${f.id}">
          <div class="face-parts">
            <div class="eyes"><div class="eye"></div><div class="eye"></div></div>
            <div class="mouth"></div>
          </div>
        </div>
      </div>
      <div style="font-weight:900;">${f.name}</div>
      <div class="meter-box"><div class="meter-bar" id="bar-${f.id}"></div></div>
    `;
    container.appendChild(div);
  });
}

function updateVisuals() {
  document.getElementById('timer').innerText = Math.ceil(state.time);
  document.getElementById('score').innerText = state.score;

  state.friends.forEach(f => {
    const el = document.getElementById(`friend-${f.id}`);
    const bar = document.getElementById(`bar-${f.id}`);
    const av = document.getElementById(`av-${f.id}`);
    const sym = document.getElementById(`sym-${f.id}`);

    // Barra
    bar.style.width = Math.min(100, f.meter) + '%';
    // Color de barra: Rojo si tiene s√≠ntoma o est√° alto
    if ((f.activeSymptom && f.activeSymptom !== 'hungry') || f.meter > 80) bar.style.background = 'var(--danger)';
    else if (f.activeSymptom === 'hungry') bar.style.background = 'var(--warn)'; // Amarillo para comida
    else bar.style.background = 'linear-gradient(90deg, #22c55e, #eab308)';

    // Avatar
    av.classList.toggle('zombie-skin', f.isZombie);
    av.classList.toggle('eyes-red', f.activeSymptom === 'eyes');
    
    // Burbuja de s√≠ntoma
    if (f.isZombie) {
      sym.textContent = 'üßü'; sym.className = 'symptom-bubble';
    } else if (f.activeSymptom) {
      sym.className = 'symptom-bubble pulse';
      if(f.activeSymptom === 'eyes') sym.textContent = 'üëÄ';
      if(f.activeSymptom === 'posture') sym.textContent = 'ü¶ê';
      if(f.activeSymptom === 'sedentary') sym.textContent = 'üï∏Ô∏è';
      if(f.activeSymptom === 'tired') sym.textContent = '‚ö°'; // Nuevo Icono
      if(f.activeSymptom === 'hungry') sym.textContent = 'üçé';
    } else {
      sym.className = 'symptom-bubble hidden';
    }

    if (f.activeSymptom && !f.isZombie) el.classList.add('critical');
    else el.classList.remove('critical');
  });
}

// --- INTERACCI√ìN ---
function triggerMerienda() {
  state.meriendaActive = true;
  state.meriendaGracePeriod = true; // Activar periodo de gracia
  
  // Asignar hambre a todos los vivos
  state.friends.forEach(f => {
    if(!f.isZombie) f.activeSymptom = 'hungry';
  });

  playSound('bell');
  const appleBtn = document.getElementById('tool-apple');
  appleBtn.classList.remove('locked');
  appleBtn.classList.add('suggested');
  
  const alert = document.createElement('div');
  alert.className = "big-alert";
  alert.innerHTML = "¬°HORA DE MERIENDA! üçé<br><span style='font-size:0.6em; font-weight:normal'>¬°Dale una manzana a todos!</span>";
  document.body.appendChild(alert);
  setTimeout(() => alert.remove(), 2500);
  
  // Quitar periodo de gracia despu√©s de 1.5s
  setTimeout(() => state.meriendaGracePeriod = false, 1500);
}

function endMerienda() {
  state.meriendaActive = false;
  // Limpiar hambre si qued√≥ alguien sin comer (y no es zombie)
  state.friends.forEach(f => {
    if(f.activeSymptom === 'hungry') f.activeSymptom = null;
  });
  
  const appleBtn = document.getElementById('tool-apple');
  appleBtn.classList.add('locked');
  appleBtn.classList.remove('suggested');
}

function applyTool(friendId, toolType) {
  const f = state.friends[friendId];
  if (f.isZombie) {
    showFloatText(friendId, "¬°Ya es Zombi!", "gray");
    playSound('error');
    return;
  }

  let success = false;
  const needed = f.activeSymptom;

  // L√≥gica de Cura
  if (toolType === 'apple' && needed === 'hungry') success = true;
  else if (toolType === 'water' && needed === 'eyes') success = true;
  else if (toolType === 'stretch' && needed === 'posture') success = true;
  else if (toolType === 'ball' && needed === 'sedentary') success = true;
  else if (toolType === 'rope' && needed === 'tired') success = true; 
  // La cuerda tambi√©n ayuda si no hay s√≠ntoma, pero menos
  else if (toolType === 'rope' && !needed && f.meter > 50) { 
    f.meter -= 10; playSound('jump'); showFloatText(friendId, "¬°Energ√≠a!", "cyan"); return;
  }

  if (success) {
    f.meter = Math.max(0, f.meter + TOOLS[toolType].effect);
    f.frozen = true; setTimeout(() => f.frozen = false, 1000);
    f.activeSymptom = null; // Quitar s√≠ntoma
    state.score++;
    playSound(TOOLS[toolType].sound);
    showFloatText(friendId, "¬°Bien!", "lime");
  } else {
    f.meter += 10; // Penalizaci√≥n por error
    playSound('error');
    showFloatText(friendId, "¬°Eso no!", "orange");
  }
}

// --- DRAG & DROP ---
function setupDragAndDrop() {
  const tools = document.querySelectorAll('.tool');
  const ghost = document.getElementById('dragGhost');
  
  tools.forEach(tool => {
    tool.addEventListener('pointerdown', e => {
      if (e.target.closest('.locked')) return;
      const t = e.target.closest('.tool');
      const type = t.dataset.type;
      const emoji = t.querySelector('.emoji').innerText;
      
      ghost.innerText = emoji;
      ghost.style.display = 'block';
      moveGhost(e);
      t.setPointerCapture(e.pointerId);
      
      t.onpointermove = moveGhost;
      t.onpointerup = (ev) => {
        ghost.style.display = 'none';
        t.onpointermove = null; t.onpointerup = null;
        const el = document.elementFromPoint(ev.clientX, ev.clientY);
        const friendEl = el?.closest('.friend');
        if (friendEl) applyTool(parseInt(friendEl.id.split('-')[1]), type);
      };
    });
  });

  function moveGhost(e) {
    ghost.style.left = e.clientX + 'px';
    ghost.style.top = e.clientY + 'px';
  }
}

// --- FIN ---
function endGame(win) {
  state.playing = false;
  showScreen('reporte');
  playSound(win ? 'win' : 'lose');
  
  const card = document.getElementById('reportCard');
  const title = document.getElementById('reportTitle');
  const msg = document.getElementById('reportMsg');
  const icon = document.getElementById('reportIcon');
  
  document.getElementById('statZombies').innerText = state.zombiesCount;
  document.getElementById('statScore').innerText = state.score;
  
  card.className = "report-card " + (win ? "win" : "lose");
  if (win) {
    title.innerText = "¬°VICTORIA!";
    title.style.color = "var(--ok)";
    icon.innerText = "üèÜ";
    msg.innerText = "¬°El equipo est√° a salvo gracias a ti!";
  } else {
    title.innerText = "¬°ZOMBIS!";
    title.style.color = "var(--danger)";
    icon.innerText = "üßü";
    msg.innerText = "El virus digital gan√≥ esta vez.";
  }
}

// --- AUDIO Y UI ---
function showFloatText(id, txt, col) {
  const el = document.getElementById(`friend-${id}`);
  const f = document.createElement('div');
  f.className = 'floater'; f.style.color = col; f.innerText = txt;
  f.style.top="50%"; f.style.left="50%"; f.style.transform="translate(-50%,-50%)";
  el.appendChild(f); setTimeout(()=>f.remove(), 1000);
}

function toggleMute() {
  muted = !muted;
  document.getElementById('btnMute').innerText = muted ? "üîá" : "üîä";
}

function playSound(type) {
  if (muted) return;
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  const osc = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  osc.connect(g); g.connect(audioCtx.destination);
  const now = audioCtx.currentTime;
  
  if (type === 'alert') {
    osc.type = 'sawtooth'; osc.frequency.setValueAtTime(600, now);
    osc.frequency.linearRampToValueAtTime(400, now+0.3);
    g.gain.setValueAtTime(0.1, now); osc.start(); osc.stop(now+0.3);
  } else if (type === 'start') {
    osc.frequency.setValueAtTime(400, now); osc.frequency.exponentialRampToValueAtTime(800, now+0.5);
    g.gain.setValueAtTime(0.1, now); osc.start(); osc.stop(now+0.5);
  } else if (type === 'error') {
    osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, now);
    g.gain.setValueAtTime(0.1, now); osc.start(); osc.stop(now+0.2);
  } else {
    osc.frequency.value = 440; g.gain.value = 0.1; osc.start(); osc.stop(now+0.1);
  }
}
</script>
</body>
</html>
